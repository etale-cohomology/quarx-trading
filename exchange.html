<!doctype html>
<html lang='en'>

  <head>
    <title>Quarx | Stellar network trading client</title>

    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>  <!-- Key for responsiveness! -->

    <link rel='icon' href='favicon.png'>
    <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Montserrat:500,800|Material+Icons'>
    <script src='material.min.js'></script>
    <link rel='stylesheet' href='material.blue-red.min.css'>
    <link rel='stylesheet' href='style.css'>
    <style>
      /*----------------------------------------------------------------------*/
      .axis text{ fill:#ffffff; font:10px 'Montserrat'; }
      text.ticker{ fill:#ffffff; font:10px 'Montserrat'; }
      path.candle{ stroke:#000000; }
      path.candle.body{ stroke-width:0; }
      path.candle.up{ fill:#00aa00; stroke:#00aa00; }
      path.candle.down{ fill:#ff0000; stroke:#ff0000; }

      path.volume{ fill:#444444; opacity:0.5; }
      path.volume.up{ fill:#00aa00; }
      path.volume.down{ fill:#ff0000; }

      rect.pane{ cursor:move; fill:none; pointer-events:all; }

      /*---------------------*/
      .indicator path.line{ fill:none; stroke-width:1; }
      .ma-0 path.line{ stroke:#1f77b4; }
      .ma-1 path.line{ stroke:#aec7e8; }
      .ma-2 path.line{ stroke:#ff7f0e; }

      /*----------------------------------------------------------------------*/
      .rsi path{ fill:none; stroke-width:1; }
      .rsi{ stroke:#ffffff; }
      .rsi path.overbought, .rsi path.oversold{ stroke:#ff9999; stroke-dasharray:5, 5; }
      .rsi path.middle, path.zero{ stroke:#bbbbbb; stroke-dasharray:5, 5; }

      /*----------------------------------------------------------------------*/
      .stochastic path { fill: none; stroke-width: 1; }
      .stochastic.up { stroke: #00aa00; }
      .stochastic.down { stroke: #ff0000; }
      .stochastic path.overbought, .stochastic path.oversold { stroke: #ff9999; stroke-dasharray: 5, 5; }
      
      /*----------------------------------------------------------------------*/
      .williams path { fill: none; stroke-width: 1; }
      .williams.up { stroke: #ffffff; stroke-width: 1.5; }

      /*----------------------------------------------------------------------*/
      .mdl-card__title{ font-weight:bold; padding:16px; }
      .main_textfield{ width:90%; color:#ffffff; }
      @media screen and (max-width:414px){ .main_textfield{ width:80%; } }
    </style>
  </head>

  <body>

    <!-- --------------------------------------------------------------------------------------------------- -->
    <div class='mdl-layout mdl-js-layout mdl-layout--fixed-header'>

      <!-- ---------------------------------------------------------------------- -->
      <header class='mdl-layout__header bg_dark'>
        <div class='mdl-layout__header-row'>
          <h1 id='title0' class='mdl-typography--title montserrat bold'>Quarx</h1>
        </div>
      </header>

      <!-- ---------------------------------------------------------------------- -->
      <div class='mdl-layout__drawer bg_dark'> <!-- 1.2 mdl-layout__drawer! -->

        <a href='/'><div class='drawer_header'></div></a>

        <nav class='mdl-navigation'>
          <a class='mdl-navigation__link' href='mass.html'><div class='material-icons'>extension</div>Mass markets</a>
          <a class='mdl-navigation__link' href='single.html'><div class='material-icons'>accessibility</div>Single markets</a>
          <a class='mdl-navigation__link' href='xlm.html'><div class='material-icons'>view_week</div>External markets</a>
          <!-- <hr class='mdl-color--white border_none'>
          <a class='mdl-navigation__link' href='manual.html'><div class='material-icons'>library_books</div>Manual</a> -->
          <hr class='mdl-color--white border_none'>
          <a class='mdl-navigation__link' href='https://github.com/etale-cohomology/quarx-trading'><div class='material-icons'>business</div>Source</a>
        </nav>

      </div>

      <!-- ---------------------------------------------------------------------- --> <!-- Content! -->
      <main class='mdl-layout__content mdl-color--grey-900'>

        <!-- ------------------------------------------------- -->
        <div class='mdl-grid mdl-grid--no-spacing mdl-color-text--white margin_top'>

          <!-- --------------------- -->
          <div class='mdl-cell mdl-cell--12-col'>
            <h1 id='exchange' class='mdl-typography--headline montserrat bold margin_left'>Exchange</h1>
          </div>

          <!-- --------------------- -->
          <div class='mdl-cell mdl-cell--8-col'>

            <!-- ------- -->
            <div class='mdl-grid flex_justify_center'>
              <div class='mdl-card mdl-shadow--4dp mdl-color--grey-900'><div id='chart0' class='mdl-cell mdl-cell--12-col'></div></div>
              <div class='mdl-card mdl-shadow--4dp mdl-color--grey-900'><div id='chart1' class='mdl-cell mdl-cell--12-col'></div></div>
              <div class='mdl-card mdl-shadow--4dp mdl-color--grey-900'><div id='chart2' class='mdl-cell mdl-cell--12-col'></div></div>
              <div class='mdl-card mdl-shadow--4dp mdl-color--grey-900'><div id='chart3' class='mdl-cell mdl-cell--12-col'></div></div>

              <div class='mdl-cell mdl-cell--12-col'>
                <h1 id='orderbook_date' class='montserrat text_center'>Orderbook updated</h1>
                <h2 id='ledger_sequence' class='montserrat text_center margin_bottom'>Ledger</h2>
              </div>
            </div>

          </div>

          <!-- --------------------- -->
          <div class='mdl-cell mdl-cell--2-col mdl-cell--4-col-tablet mdl-cell--4-col-phone'>

            <h2 id='bids_title' class='text_center'>Bids</h2>
            <table id='bids_table' class='mdl-data-table mdl-js-data-table mdl-shadow--2dp mdl-color--grey-900 width_96'>
              <thead><tr><th>Market size integral</th><th>Market size</th><th>Price</th></tr></thead>
              <tbody></tbody>
            </table>


            <div class='mdl-grid mdl-grid--no-spacing'>

              <div class='mdl-card spread_card mdl-shadow--2dp mdl-color--grey-900'>
                <div id='spread_absolute_title' class='mdl-card__supporting-text mdl-color-text--white montserrat'>Spread</div>
                <div class='mdl-card__title'>
                  <div id='spread_absolute' class='mdl-card__title-text mdl-color-text--white montserrat'></div>
                </div>
              </div>

              <div class='mdl-card spread_card mdl-shadow--2dp mdl-color--grey-900'>
                <div class='mdl-card__supporting-text mdl-color-text--white montserrat'>Spread (%)</div>
                <div class='mdl-card__title'>
                  <div id='spread_relative' class='mdl-card__title-text mdl-color-text--white montserrat'></div>
                </div>
              </div>

            </div>


            <h2 id='asks_title' class='text_center'>Asks</h2>
            <table id='asks_table' class='mdl-data-table mdl-js-data-table mdl-shadow--2dp mdl-color--grey-900 width_96'>
              <thead><tr><th>Market size integral</th><th>Market size</th><th>Price</th></tr></thead>
              <tbody></tbody>
            </table>

          </div>

          <!-- --------------------- Spacer! =D -->
          <!-- <div class='mdl-cell--stretch mdl-cell--1-col'></div> -->

          <!-- --------------------- -->
          <div class='mdl-cell mdl-cell--2-col mdl-cell--4-col-tablet mdl-cell--4-col-phone'>
            <h1 id='trades_last' class='text_center'>Last trades</h1>
            <table id='trades_table' class='mdl-data-table mdl-js-data-table mdl-shadow--2dp mdl-color--grey-900 width_96'>
              <thead><tr><th>Trade size</th><th>Price</th><th>Time</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

        </div>  <!-- END mdl-grid -->

        <!-- ------------------------------------------------- -->
        <div class='mdl-grid mdl-grid--no-spacing mdl-color-text--white flex_justify_center'>

          <!-- --------------------- -->
          <div class='mdl-cell mdl-cell--6-col mdl-cell--12-col-tablet flex_justify_center'>

            <div class='mdl-card mdl-shadow--4dp width_100 mdl-color--grey-800'>

              <div class='mdl-card__title mdl-color--black mdl-color-text--white vcenter_parent'>
                <h2 id='card_title_buy' class='mdl-typography--headline vcenter_child bold'>Sell</h2>
                <div class='mdl-layout-spacer'></div>
                <button class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon' id='help_sell_asset1'><i class='material-icons'>help_outline</i></button>
                <div class='mdl-tooltip' for='help_sell_asset1' id='tooltip_sell_asset1'><br>In the Stellar network, an <b>asset</b> is specified by two pieces of data: 1) an asset code and 2) an <b>asset issuer</b>. This means that, in order to sell an asset, you need both the asset code and the asset issuer. An asset issuer is an account that created and first sent an asset. All assets except Lumens have an issuer. In this page, the <b>asset issuer</b> is <i>already selected</i>.</div>
              </div>

              <div class='mdl-card__supporting-text width_100'>
                <button class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white margin_right3' id='help_sell_asset1_price'><i class='material-icons'>explore</i></button>
                <div class='mdl-tooltip' for='help_sell_asset1_price' id='tooltip_sell_asset1_price'><b>Price</b> for 1 unit of the <b>selling asset</b> (see table title) in exchange for the counter asset.</div>
                <div class='mdl-textfield mdl-js-textfield main_textfield'>
                  <input class='mdl-textfield__input' type='text' id='input_buy_price'/>
                  <label class='mdl-textfield__label mdl-color-text--grey-500'>Selling price</label>
                </div>
              </div>

              <div class='mdl-card__supporting-text width_100'>
                <button class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white margin_right3' id='help_sell_asset1_amount'><i class='material-icons'>whatshot</i></button>
                <div class='mdl-tooltip' for='help_sell_asset1_amount' id='tooltip_sell_asset1_amount'>Amount to sell of the <b>selling asset</b> (see table title).</div>
                <div class='mdl-textfield mdl-js-textfield main_textfield'>
                  <input class='mdl-textfield__input' type='text' id='input_buy_amount'/>
                  <label class='mdl-textfield__label mdl-color-text--grey-500'>Amount to sell</label>
                </div>
              </div>

              <div class='mdl-card__supporting-text width_100'>
                <button class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white margin_right3' id='help_sell_asset1_secret_seed'><i class='material-icons'>lock_outline</i></button>
                <div class='mdl-tooltip' for='help_sell_asset1_secret_seed'>In order to cryptographically <b>sign</b> a <b>transaction</b> to <i>submit</i> to the Stellar network, you must use your <b>secret seed</b>. We <i>never</i> store your secret seed anywhere.</div>
                <div class='mdl-textfield mdl-js-textfield main_textfield'>
                  <input class='mdl-textfield__input' type='text' id='input_buy_secret_seed'/>
                  <label class='mdl-textfield__label mdl-color-text--grey-500'>Secret seed</label>
                </div>
              </div>

              <div class='mdl-card__actions mdl-card--border vcenter_parent margin_top4'>
                <div class='mdl-layout-spacer'></div>
                <div id='spinner_buy' class='mdl-spinner mdl-js-spinner vcenter_child margin_right3'></div>
                <button id='btn_buy' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-button--accent vcenter_child vcenter_parent'>buy<i class='material-icons vcenter_child margin_left4'>send</i></button>
              </div>

            </div>

          </div>

          <!-- --------------------- -->
          <div class='mdl-cell mdl-cell--6-col mdl-cell--12-col-tablet flex_justify_center'>

            <div class='mdl-card mdl-shadow--4dp width_100 mdl-color--grey-800'>

              <div class='mdl-card__title mdl-color--black mdl-color-text--white vcenter_parent'>
                <h2 id='card_title_sell' class='mdl-typography--headline vcenter_child bold'>Sell</h2>
                <div class='mdl-layout-spacer'></div>
                <button class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon' id='help_sell_asset0'><i class='material-icons'>help_outline</i></button>
                <div class='mdl-tooltip' for='help_sell_asset0' id='tooltip_sell_asset0'><br>In the Stellar network, an <b>asset</b> is specified by two pieces of data: 1) an asset code and 2) an <b>asset issuer</b>. This means that, in order to sell an asset, you need both the asset code and the asset issuer. An asset issuer is an account that created and first sent an asset. All assets except Lumens have an issuer. In this page, the <b>asset issuer</b> is <i>already selected</i>.</div>
              </div>

              <div class='mdl-card__supporting-text width_100'>
                <button class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white margin_right3' id='help_sell_asset0_price'><i class='material-icons'>explore</i></button>
                <div class='mdl-tooltip' for='help_sell_asset0_price' id='tooltip_sell_asset0_price'><b>Price</b> for 1 unit of the <b>selling asset</b> (see table title) in exchange for the counter asset.</div>
                <div class='mdl-textfield mdl-js-textfield main_textfield'>
                  <input class='mdl-textfield__input' type='text' id='input_sell_price'/>
                  <label class='mdl-textfield__label mdl-color-text--grey-500'>Selling price</label>
                </div>
              </div>

              <div class='mdl-card__supporting-text width_100'>
                <button class='mdl-button mdl-js-button mdl-js-button-ripple-effect mdl-button--icon mdl-color--white margin_right3' id='help_sell_asset0_amount'><i class='material-icons'>whatshot</i></button>
                <div class='mdl-tooltip' for='help_sell_asset0_amount' id='tooltip_sell_asset0_amount'>Amount to sell of the <b>selling asset</b> (see table title).</div>
                <div class='mdl-textfield mdl-js-textfield main_textfield'>
                  <input class='mdl-textfield__input' type='text' id='input_sell_amount'/>
                  <label class='mdl-textfield__label mdl-color-text--grey-500'>Amount to sell</label>
                </div>
              </div>

              <div class='mdl-card__supporting-text width_100'>
                <button class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white margin_right3' id='help_sell_asset0_secret_seed'><i class='material-icons'>lock_outline</i></button>
                <div class='mdl-tooltip' for='help_sell_asset0_secret_seed'>In order to cryptographically <b>sign</b> a <b>transaction</b> to <i>submit</i> to the Stellar network, you must use your <b>secret seed</b>. We <i>never</i> store your secret seed anywhere.</div>
                <div class='mdl-textfield mdl-js-textfield main_textfield'>
                  <input class='mdl-textfield__input' type='text' id='input_sell_secret_seed'/>
                  <label class='mdl-textfield__label mdl-color-text--grey-500'>Secret seed</label>
                </div>
              </div>

              <div class='mdl-card__actions mdl-card--border vcenter_parent margin_top4'>
                <div class='mdl-layout-spacer'></div>
                <div id='spinner_sell' class='mdl-spinner mdl-js-spinner vcenter_child margin_right3'></div>
                <button id='btn_sell' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-button--accent vcenter_child vcenter_parent'>sell<i class='material-icons vcenter_child margin_left4'>send</i></button>
              </div>

            </div>

          </div>

          <!-- --------------------- -->
          <div class='mdl-cell mdl-cell--6-col'>

            <h2 class='mdl-typography--subhead montserrat bold text_center margin_top'>Market components
            <button id='help_market_components' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon margin_bottom2'><i class='material-icons'>help_outline</i></button>
            <div class='mdl-tooltip' for='help_market_components'>This is the list of <b>anchors</b> that are being considered in this <b>market</b>. If you place a <b>trade</b>, it'll be against one of these accounts; make sure you <b>trust</b> them first! Click on a market component / participant to view its account profile on <b>Stellar Desk</b>.</div>
            </h2>
            <table id='market_components_table' class='mdl-data-table mdl-js-data-table mdl-shadow--2dp mdl-color--grey-900 hcenter'>
              <tbody></tbody>
            </table>

          </div>

        </div>  <!-- END mdl-grid -->

        <!-- ------------------------------------------------- Snackbars! -->
        <div id='snackbar_error' class='mdl-snackbar mdl-js-snackbar mdl-color--red'>
          <div class='mdl-snackbar__text'></div>
          <button class='mdl-snackbar__action' type='button'></button>
        </div>

        <div id='snackbar_success' class='mdl-snackbar mdl-js-snackbar mdl-color--green'>
          <div class='mdl-snackbar__text'></div>
          <button class='mdl-snackbar__action' type='button'></button>
        </div>

        <!-- ------------------------------------------------- -->
        <footer class='mdl-mini-footer mdl-color--black margin_top6'>

          <div class='mdl-mini-footer--left-section'>
            <a href='/' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color-text--white' role='presentation'><i class='material-icons'>home</i></a>
            <a href='mass.html' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color-text--white' role='presentation'><i class='material-icons'>extension</i></a>
            <a href='single.html' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color-text--white' role='presentation'><i class='material-icons'>accessibility</i></a>
            <a href='xlm.html' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color-text--white' role='presentation'><i class='material-icons'>view_week</i></a>
            <a href='https://github.com/etale-cohomology/quarx-trading' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color-text--white' role='presentation'><i class='material-icons'>business</i></a>
          </div>

          <div class='mdl-mini-footer--right-section'>
            <a href='https://stellar.org' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color-text--white' role='presentation'><i class='material-icons'>favorite</i></a>
          </div>

        </footer>

      </main>

    </div>

  </body>

  <script src='stellar-sdk.min.js'></script>
  <script src='d3.v4.min.js'></script>
  <script src='techan.min.js'></script>
  <script src='main.js'></script>
  <script>
    // ---------------------------------------------------------------------------------------------------
    // Create snackbars! Doesn't work, either!
    // let snackbar_success = doc.createElement('div')
    // let snackbar_success_text = doc.createElement('div')
    // let snackbar_success_button = doc.createElement('button')

    // snackbar_success.id = 'snackbar_success'
    // snackbar_success.className = 'mdl-snackbar mdl-js-snackbar mdl-color--green'
    // snackbar_success_text.className = 'mdl-snackbar__text'
    // snackbar_success_button.className = 'mdl-snackbar__action'

    // snackbar_success.appendChild(snackbar_success_text)
    // snackbar_success.appendChild(snackbar_success_button)
    // componentHandler.upgradeElement(snackbar_success)
    // doc.body.appendChild(snackbar_success)




    // ---------------------------------------------------------------------------------------------------
    // ---------------------------------------------------------------------------------------------------
    // ---------------------------------------------------------------------------------------------------
    function asset_buy_execute(){
      btn_disable('btn_buy')
      spinner_enable('spinner_buy')

      let account0_seed = doc.querySelector('#input_buy_secret_seed').value
      let account0_id
      try{
        account0_id = StellarSdk.Keypair.fromSeed(account0_seed).accountId()
      }catch(error){
        buy_asset_error(error, 'Error: invalid secret seed')
        return
      }
      account0_seed = undefined

      HORIZON.loadAccount(account0_id).then(buy_asset_callback)
    }

    function buy_asset_callback(account){
      let account0 = new StellarSdk.Account(account.id, account.sequence)
      let account0_seed = doc.querySelector('#input_buy_secret_seed').value

      let price = doc.querySelector('#input_buy_price').value
      let amount = doc.querySelector('#input_buy_amount').value
      let buying_asset = new StellarSdk.Asset(url_get('buying_asset_code'), url_get('buying_asset_issuer'))
      let selling_asset = new StellarSdk.Asset(url_get('selling_asset_code'), url_get('selling_asset_issuer'))

      if(!(price > 0)){
        generic_error_snackbar_show('Error: price must be a positive number.')
        btn_enable('btn_buy')
        spinner_disable('spinner_buy')
        account0_seed = undefined
        return
      }
      if(!(amount > 0)){
        generic_error_snackbar_show('Error: amount must be a positive number.')
        btn_enable('btn_buy')
        spinner_disable('spinner_buy')
        account0_seed = undefined
        return
      }

      operation_buy_asset(account0, account0_seed, buying_asset, selling_asset, price, amount)
      account0_seed = undefined
    }

    // If <= highest bid, SELL `selling` with amount by matching agains highest bid
    // If > highest bid, place limit order to SELL `selling` asset
    function operation_buy_asset(account0, account0_seed, buying_asset, selling_asset, price, amount){
      let tx = {buying: buying_asset,
                selling: selling_asset,
                price: price,//round(1 / parseFloat(price), 7),  // Price of 1 unit of `selling` in terms of `buying`!
                amount: amount}//round(parseFloat(amount) / parseFloat(price)).toString()}//round(1 / parseFloat(amount), 7).toString()}  // Amount of `selling`!
      print('buying_asset', buying_asset)
      print('selling_asset', selling_asset)
      print('transaction', tx)
      let operation = StellarSdk.Operation.manageOffer(tx)
      let transaction = new StellarSdk.TransactionBuilder(account0).addOperation(operation).build()  // 1. Build transaction!
      transaction.sign(StellarSdk.Keypair.fromSeed(account0_seed))  // 2. Sign transaction!
      HORIZON.submitTransaction(transaction).then(buy_asset_success).catch(buy_asset_error)  // 3. Submit transaction!
      account0_seed = undefined
    }

    // ----------------------------------------------------------------------
    function buy_asset_success(operation){
      btn_enable('btn_buy')
      spinner_disable('spinner_buy')

      let snackbar_div = doc.querySelector('#snackbar_success')
      let snackbar_data = {message: 'Buy order placed successfully!'}
      // snackbar_div.MaterialSnackbar.showSnackbar(snackbar_data)

      doc.querySelector('#input_buy_secret_seed').value = ''

      print(arguments.callee.name, operation)
    }

    function buy_asset_error(error, msg){
      btn_enable('btn_buy')
      spinner_disable('spinner_buy')

      let snackbar_div = doc.querySelector('#snackbar_error')
      let snackbar_data = {message: msg}
      // snackbar_div.MaterialSnackbar.showSnackbar(snackbar_data)

      print(error.detail, error)
    }


    // ---------------------------------------------------------------------------------------------------
    function asset_sell_execute(){
      btn_disable('btn_sell')
      spinner_enable('spinner_sell')

      let account0_seed = doc.querySelector('#input_sell_secret_seed').value
      let account0_id
      try{
        account0_id = StellarSdk.Keypair.fromSeed(account0_seed).accountId()
      }catch(error){
        sell_asset_error(error, 'Error: invalid secret seed')
        return
      }
      account0_seed = undefined

      HORIZON.loadAccount(account0_id).then(sell_asset_callback)
    }

    function sell_asset_callback(account){
      let account0 = new StellarSdk.Account(account.id, account.sequence)
      let account0_seed = doc.querySelector('#input_sell_secret_seed').value

      let price = doc.querySelector('#input_sell_price').value
      let amount = doc.querySelector('#input_sell_amount').value
      let buying_asset = new StellarSdk.Asset(url_get('buying_asset_code'), url_get('buying_asset_issuer'))
      let selling_asset = new StellarSdk.Asset(url_get('selling_asset_code'), url_get('selling_asset_issuer'))

      if(!(price > 0)){
        generic_error_snackbar_show('Error: price must be a positive number.')
        btn_enable('btn_sell')
        spinner_disable('spinner_sell')
        account0_seed = undefined
        return
      }
      if(!(amount > 0)){
        generic_error_snackbar_show('Error: amount must be a positive number.')
        btn_enable('btn_sell')
        spinner_disable('spinner_sell')
        account0_seed = undefined
        return
      }

      operation_sell_asset(account0, account0_seed, buying_asset, selling_asset, price, amount)
      account0_seed = undefined
    }

    function operation_sell_asset(account0, account0_seed, buying_asset, selling_asset, price, amount){
      let tx = {buying: buying_asset,
                selling: selling_asset,
                price: price,
                amount: amount}
      print('buying_asset', buying_asset)
      print('selling_asset', selling_asset)
      print('transaction', tx)
      let operation = StellarSdk.Operation.manageOffer(tx)
      let transaction = new StellarSdk.TransactionBuilder(account0).addOperation(operation).build()  // 1. Build transaction!
      transaction.sign(StellarSdk.Keypair.fromSeed(account0_seed))  // 2. Sign transaction!
      HORIZON.submitTransaction(transaction).then(sell_asset_success).catch(sell_asset_error)  // 3. Submit transaction!
      account0_seed = undefined
    }

    // ----------------------------------------------------------------------
    function sell_asset_success(operation){
      btn_enable('btn_sell')
      spinner_disable('spinner_sell')

      let snackbar_div = doc.querySelector('#snackbar_success')
      let snackbar_data = {message: 'sell order placed successfully!'}
      // snackbar_div.MaterialSnackbar.showSnackbar(snackbar_data)

      doc.querySelector('#input_sell_secret_seed').value = ''

      print(arguments.callee.name, operation)
    }

    function sell_asset_error(error, msg){
      btn_enable('btn_sell')
      spinner_disable('spinner_sell')

      let snackbar_div = doc.querySelector('#snackbar_error')
      let snackbar_data = {message: msg}
      // snackbar_div.MaterialSnackbar.showSnackbar(snackbar_data)

      print(error.detail, error)
    }




    // ---------------------------------------------------------------------------------------------------
    // ---------------------------------------------------------------------------------------------------
    // ---------------------------------------------------------------------------------------------------
    function exchange_title(buying_asset_code, selling_asset_code){
      doc.querySelector('#exchange').innerText = `Exchange ${buying_asset_code}/${selling_asset_code}`
    }

    function trades_title(buying_asset_code, selling_asset_code){
      doc.querySelector('#trades_last').innerText = `Last trades ${buying_asset_code}/${selling_asset_code}`
    }

    function bidask_title(buying_asset_code, selling_asset_code){
      doc.querySelector('#bids_title').innerText = `Bids ${buying_asset_code}/${selling_asset_code}`
      doc.querySelector('#asks_title').innerText = `Asks ${buying_asset_code}/${selling_asset_code}`
    }

    function order_cards_tooltips(buying_asset_code, selling_asset_code){
      doc.querySelector('#tooltip_sell_asset1_price').innerHTML = `<b>Price</b> for 1 unit of <b>${selling_asset_code}</b> in exchange for <b>${buying_asset_code}</b>.`
      doc.querySelector('#tooltip_sell_asset0_price').innerHTML = `<b>Price</b> for 1 unit of <b>${buying_asset_code}</b> in exchange for <b>${selling_asset_code}</b>.`
      doc.querySelector('#tooltip_sell_asset1_amount').innerHTML = `Amount of <b>${selling_asset_code}</b> to sell.`
      doc.querySelector('#tooltip_sell_asset0_amount').innerHTML = `Amount of <b>${buying_asset_code}</b> to sell.`
      doc.querySelector('#tooltip_sell_asset1').innerHTML = `<b>Sell</b> your <b>${selling_asset_code}</b> in exchange for <b>${buying_asset_code}</b>.<br>An <b>asset</b> is given by 2 pieces of data: 1) an <b>asset code</b> and 2) an <b>asset issuer</b>. All assets except Lumens have an issuer. Here, the <b>issuer</b> is <i>already selected</i>.`
      doc.querySelector('#tooltip_sell_asset0').innerHTML = `<b>Sell</b> your <b>${buying_asset_code}</b> in exchange for <b>${selling_asset_code}</b>.<br>An <b>asset</b> is given by 2 pieces of data: 1) an <b>asset code</b> and 2) an <b>asset issuer</b>. All assets except Lumens have an issuer. Here, the <b>issuer</b> is <i>already selected</i>.`
    }

    function market_components(market){
      let table = doc.querySelector('#market_components_table')
      let tbody_html = ''
      for(let component of market)
        tbody_html += `<tr><td><a href='https://stellardesk.org/accounts?account=${component}'>${component}</a></td></tr>`
      table.tBodies[0].innerHTML = tbody_html
    }


    // ---------------------------------------------------------------------------------------------------
    let MARKETS = {
      CNY: ['GAREELUB43IRHWEASCFBLKHURCGMHE5IF6XSE7EXDLACYHGRHM43RFOX',],
      JPY: ['GBVAOIACNSB7OVUXJYC5UE2D4YK2F7A24T7EE5YOMN4CE6GCHUTOUQXM'],
      BTC: ['GDXTJEK4JZNSTNQAWA53RZNS2GIKTDRPEUWDXELFMKU52XNECNVDVXDI'],  // 'GAUTUYY2THLF7SGITDFMXJVYH3LHDSMGEAKSBU267M2K7A3W543CKUEF', 'GBSTRH4QOTWNSVA6E4HFERETX4ZLSR3CIUBLK7AXYII277PFJC4BBYOG'
      XRP: ['GA7FCCMTTSUIC37PODEL6EOOSPDRILP6OQI5FWCWDDVDBLJV72W6RINZ'],
    }


    // ---------------------------------------------------------------------------------------------------
    function parse_xlm(asset_code, asset_issuer){
      if(asset_code == 'XLM')   return new StellarSdk.Asset.native()
      else                      return new StellarSdk.Asset(asset_code, asset_issuer)
    }

    // ----------------------------------------------------------------------
    let buying_asset_code  = url_get('buying_asset_code')
    let buying_asset_issuer  = url_get('buying_asset_issuer')
    let selling_asset_code = url_get('selling_asset_code')
    let selling_asset_issuer = url_get('selling_asset_issuer')

    let buying_asset
    let selling_asset
    if(buying_asset_issuer == 'mass' || selling_asset_issuer == 'mass'){
      buying_asset  = new StellarSdk.Asset.native()
      selling_asset = new StellarSdk.Asset(selling_asset_code, MARKETS[selling_asset_code][0])
      market_components(MARKETS[selling_asset_code])
      print('mass market')
    }else{
      buying_asset  = parse_xlm(buying_asset_code, buying_asset_issuer)
      selling_asset = new parse_xlm(selling_asset_code, selling_asset_issuer)
      market_components([buying_asset_issuer, selling_asset_issuer].unique())
      print('single market')
    }

    orderbook_get(buying_asset, selling_asset)
    trades_init(buying_asset, selling_asset)

    exchange_title(buying_asset_code, selling_asset_code)
    trades_title(buying_asset_code, selling_asset_code)
    bidask_title(buying_asset_code, selling_asset_code)
    order_cards_tooltips(buying_asset_code, selling_asset_code)


    // ---------------------------------------------------------------------------------------------------
    // Buy/sell button control!
    doc.querySelector('#btn_buy').onclick = asset_buy_execute
    doc.querySelector('#btn_sell').onclick = asset_sell_execute
    doc.querySelector('#input_buy_price').onkeypress = function(event){         if(event.keyCode == 13)  asset_buy_execute() }
    doc.querySelector('#input_buy_amount').onkeypress = function(event){        if(event.keyCode == 13)  asset_buy_execute() }
    doc.querySelector('#input_buy_secret_seed').onkeypress = function(event){   if(event.keyCode == 13)  asset_buy_execute() }
    doc.querySelector('#input_sell_price').onkeypress = function(event){        if(event.keyCode == 13)  asset_sell_execute() }
    doc.querySelector('#input_sell_amount').onkeypress = function(event){       if(event.keyCode == 13)  asset_sell_execute() }
    doc.querySelector('#input_sell_secret_seed').onkeypress = function(event){  if(event.keyCode == 13)  asset_sell_execute() }


    // ---------------------------------------------------------------------------------------------------
    // Set card titles!
    doc.querySelector('#card_title_buy').innerText = `Sell ${selling_asset_code.toUpperCase()}`
    doc.querySelector('#card_title_sell').innerText = `Sell ${buying_asset_code.toUpperCase()}`
    doc.querySelector('#btn_buy').innerHTML = `Sell ${selling_asset_code.toUpperCase()} <i class='material-icons vcenter_child margin_left4'>send</i>`
    doc.querySelector('#btn_sell').innerHTML = `Sell ${buying_asset_code.toUpperCase()} <i class='material-icons vcenter_child margin_left4'>send</i>`
  </script>

</html>
